<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gas Laws Simulator — Boyles • Charles • Gay-Lussac</title>
  <meta name="description" content="Gas laws simulator (Boyle, Charles, Gay-Lussac). Interactive neon sci-fi UI with particle visualization."/>
  <meta name="color-scheme" content="dark">
  <!-- Optional: Google font (inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1: #061026;
      --bg-2: #07122a;
      --accent-c: #00eaff;
      --accent-p: #7a6bff;
      --muted: #9fb2c8;
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
      --radius: 12px;
      --card-pad: 14px;
      --max-width: 1180px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      --ui: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:
      radial-gradient(900px 420px at 8% 8%, rgba(122,107,255,0.05), transparent),
      linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:#e6f2ff;font-family:var(--ui);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    /* Layout */
    .app {
      max-width:var(--max-width);
      margin:20px auto;
      padding:18px;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:18px;
      align-items:start;
    }
    @media (max-width:1000px){
      .app{grid-template-columns: 1fr; padding:14px}
    }

    /* Header */
    header.sim-header {
      display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;
    }
    .brand {
      display:flex;align-items:center;gap:12px;
    }
    .mark{
      width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent-c),var(--accent-p));
      display:flex;align-items:center;justify-content:center;color:#021022;font-weight:800;font-size:18px;box-shadow:0 8px 26px rgba(122,107,255,0.12);
    }
    h1{margin:0;font-size:18px}
    .subtitle{margin:0;color:var(--muted);font-size:13px}

    /* Cards */
    .card {
      background: linear-gradient(180deg,var(--glass),var(--glass-2));
      border-radius:var(--radius);
      padding:var(--card-pad);
      border:1px solid rgba(255,255,255,0.03);
      box-shadow: 0 18px 40px rgba(2,6,12,0.55);
    }

    /* Canvas area (left) */
    .sim-area { display:flex;flex-direction:column; gap:12px; min-width:0 }
    .visual {
      border-radius:10px;
      overflow:hidden;
      background:linear-gradient(180deg, rgba(6,8,16,0.6), rgba(3,6,12,0.75));
      border:1px solid rgba(255,255,255,0.03);
      padding:12px;
    }
    .canvas-outer{ display:flex; gap:12px; flex-direction:column }
    .canvas-holder { width:100%; aspect-ratio: 820/420; min-height:160px; position:relative; border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center }
    canvas{ display:block; width:100%; height:100%; }

    /* Controls under canvas */
    .controls-row { display:flex; gap:12px; justify-content:space-between; align-items:center; flex-wrap:wrap }
    .controls-left { display:flex; gap:8px; align-items:center; min-width:0 }
    .btn {
      appearance:none;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;
      background:linear-gradient(90deg,var(--accent-c),var(--accent-p)); color:#021022; box-shadow:0 8px 28px rgba(122,107,255,0.08);
    }
    .btn.secondary {
      background:transparent;color:var(--accent-c);border:1px solid rgba(255,255,255,0.04); box-shadow:none;
    }
    .btn.ghost { background:transparent;border:1px dashed rgba(255,255,255,0.03); color:var(--muted) }

    .stats { display:flex; gap:10px; align-items:center; flex-wrap:wrap; min-width:0 }
    .stat {
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:10px;border-radius:10px;min-width:84px;text-align:center;font-weight:800;color:#cbefff;border:1px solid rgba(255,255,255,0.03)
    }
    .stat .label{font-size:11px;color:var(--muted);font-weight:600}

    /* Two-block legend/pressure hint area */
    .info-row { display:flex; gap:12px; margin-top:6px; flex-wrap:wrap }
    .info-row > div{ flex:1; min-width:180px }
    .legend, .hint-box {
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);color:var(--muted); font-size:13px;
    }

    /* Right panel (controls) */
    aside.panel { position:relative }
    aside.panel h2{ color:var(--accent-p); margin:0 0 8px 0; font-size:15px }
    .desc{ color:var(--muted); font-size:13px; line-height:1.45; margin-bottom:12px }

    .form-row{ display:flex; gap:10px; align-items:center; width:100%; margin-bottom:12px; flex-wrap:wrap }
    label{ display:block; font-weight:700; font-size:13px; color:#d8ecff; margin-bottom:6px }
    select, input[type="range"], input[type="number"] { width:100%; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.03); padding:8px; color:inherit }
    .range-wrap { width:100% }
    .readout { text-align:right; font-weight:800; color:#dff9ff; font-size:13px; margin-top:6px }

    .preset-row { display:flex; gap:8px; flex-wrap:wrap }
    .preset-row .btn.secondary{ padding:8px 10px; font-weight:700 }

    .small-hint { font-size:12px; color:var(--muted); margin-top:10px }

    /* Focus + accessibility */
    button:focus, input:focus, select:focus { outline:2px solid rgba(0,234,255,0.12); outline-offset:2px; border-radius:8px }
    .sr-only { position:absolute;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;padding:0;margin:-1px }

    /* Floating back button (mobile safe) */
    .back {
      position:fixed; left:16px; bottom:16px; z-index:999; display:inline-flex; gap:8px; align-items:center;
      background:linear-gradient(180deg, rgba(0,234,255,0.06), rgba(122,107,255,0.04));
      color:var(--accent-c); padding:10px 12px; border-radius:12px; border:1px solid rgba(0,234,255,0.12); text-decoration:none; font-weight:700;
      box-shadow:0 8px 30px rgba(0,234,255,0.06); backdrop-filter: blur(6px);
    }
    @media (max-width:420px){ .back{ left:10px; bottom:10px; padding:8px 10px; font-size:13px } }

    /* Responsive adjustments */
    @media (max-width:860px){
      .card, aside.panel { padding:12px }
      .canvas-holder{ aspect-ratio: 4/2 }
      canvas{ border-radius:6px }
      .app{ gap:12px }
      .stat{ min-width:68px; padding:8px; font-size:13px }
    }
    @media (max-width:560px){
      .controls-row{ flex-direction:column; align-items:stretch }
      .controls-left{ justify-content:flex-start }
      .preset-row{ justify-content:flex-start }
      .canvas-holder{ aspect-ratio: 3/2 }
      canvas{ height:auto!important }
    }
    /* Prevent horizontal overflow from legacy inline widths */
    @media (max-width:480px){
      [style*="min-width:260px"], [style*="min-width:220px"], [style*="width:320px"]{ min-width:0!important; width:100%!important; max-width:100%!important }
      html,body{ overflow-x:hidden; -webkit-overflow-scrolling:touch }
    }

  </style>
</head>
<body>
  <!-- Floating Back -->
  <a href="index.html" class="back" aria-label="Back to Index">⬅ Back</a>

  <main class="app" id="app" role="main" aria-labelledby="title">
    <!-- Left: Simulator -->
    <section class="card sim-area" aria-labelledby="title">
      <header class="sim-header">
        <div class="brand" aria-hidden="false">
          <div class="mark" aria-hidden="true">G</div>
          <div>
            <h1 id="title">Gas Laws — Simulation Lab</h1>
            <p class="subtitle">Boyle • Charles • Gay-Lussac — interactive visualization</p>
          </div>
        </div>
        <div aria-hidden="true" class="small-hint">Keyboard: ← → (volume) • Space (play/pause) • P (print)</div>
      </header>

      <div class="visual" role="region" aria-label="Gas simulation area">
        <div class="canvas-outer">
          <div class="canvas-holder" id="canvasWrap">
            <canvas id="simCanvas" width="820" height="420" role="img" aria-label="Gas molecules visual"></canvas>
          </div>
          <div class="controls-row" aria-hidden="false">
            <div class="controls-left">
              <button id="playBtn" class="btn" aria-pressed="false" title="Pause/Play (Space)">Pause</button>
              <button id="resetBtn" class="btn secondary" title="Reset simulation">Reset</button>
              <button id="demoBtn" class="btn ghost" title="Run demo sequence">Run Demo</button>
            </div>

            <div class="stats" role="status" aria-live="polite">
              <div class="stat" id="pvBox"><div class="label">Pressure</div><div class="value" aria-hidden="true">P = ? atm</div></div>
              <div class="stat" id="vvBox"><div class="label">Volume</div><div class="value" aria-hidden="true">V = ? L</div></div>
              <div class="stat" id="ttBox"><div class="label">Temp</div><div class="value" aria-hidden="true">T = ? K</div></div>
            </div>
          </div>

          <div class="info-row" aria-hidden="false">
            <div>
              <div style="font-weight:800;color:var(--accent-p);margin-bottom:6px">Legend</div>
              <div class="legend">Each dot = gas molecule. Color indicates temperature (blue → cyan → orange → red). Faster motion → higher temperature. Collisions with walls produce pressure.</div>
            </div>
            <div>
              <div style="font-weight:800;color:var(--accent-p);margin-bottom:6px">Pressure hint</div>
              <div class="hint-box">Container glow intensifies with pressure. Use presets to explore isothermal, isochoric, and isobaric processes.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Right: Controls & Presets -->
    <aside class="card panel" aria-label="Controls & presets">
      <h2>Controls & Presets</h2>
      <div class="desc">Adjust sliders or select a mode. The simulator enforces <code>PV = nRT</code> (n = 1, R = 0.082 L·atm·K⁻¹·mol⁻¹) — one variable is computed depending on the law.</div>

      <div class="form-row" style="flex-direction:column">
        <label for="mode">Gas Law Mode</label>
        <select id="mode" aria-label="Gas law mode">
          <option value="boyle">Boyle (P–V) — temperature fixed</option>
          <option value="charles">Charles (V–T) — pressure fixed</option>
          <option value="gay">Gay-Lussac (P–T) — volume fixed</option>
        </select>
      </div>

      <div class="form-row" style="flex-direction:column">
        <label for="vol">Volume V (L)</label>
        <div class="range-wrap">
          <input id="vol" type="range" min="1" max="10" step="0.01" value="5" aria-label="Volume slider" />
        </div>
        <div class="readout" id="volVal">5.00 L</div>
      </div>

      <div class="form-row" style="flex-direction:column">
        <label for="temp">Temperature T (K)</label>
        <div class="range-wrap">
          <input id="temp" type="range" min="200" max="600" step="1" value="300" aria-label="Temperature slider" />
        </div>
        <div class="readout" id="tempVal">300 K</div>
      </div>

      <div class="form-row" style="flex-direction:column">
        <label for="pres">Pressure P (atm)</label>
        <div class="range-wrap">
          <input id="pres" type="range" min="0.5" max="5" step="0.001" value="1" aria-label="Pressure slider" />
        </div>
        <div class="readout" id="presVal">1.00 atm</div>
      </div>

      <div style="margin-top:6px">
        <div style="font-weight:800;margin-bottom:8px">Presets</div>
        <div class="preset-row" role="group" aria-label="Presets">
          <button id="isoTemp" class="btn secondary" title="Isothermal preset">Isothermal</button>
          <button id="isoVol" class="btn secondary" title="Isochoric preset">Isochoric</button>
          <button id="isoPres" class="btn secondary" title="Isobaric preset">Isobaric</button>
          <button id="demoToggle" class="btn" title="Alternate demo button">Run Demo</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <div style="font-weight:800;margin-bottom:8px">Particles</div>
        <div style="display:flex;gap:8px;align-items:center">
          <label for="particleCount" style="margin:0;color:var(--muted)">Count</label>
          <select id="particleCount" style="margin-left:auto;padding:6px;border-radius:8px" aria-label="Particle count">
            <option value="40">40</option>
            <option value="60" selected>60</option>
            <option value="90">90</option>
            <option value="140">140</option>
          </select>
        </div>
      </div>

      <div class="small-hint">Tip: adjust one slider and choose a mode to let the simulator compute the constrained quantity. Space toggles play/pause.</div>
      <div style="height:10px"></div>
    </aside>
  </main>

  <script>
  /**
   * Gas Laws Simulator — modern refactor
   * - Single-file, modular functions
   * - Responsive canvas with DPR handling
   * - PV = n R T implemented (n=1)
   * - Modes: Boyle (P-V: T fixed), Charles (V-T: P fixed), Gay-Lussac (P-T: V fixed)
   * - Particles reflect, color by temperature, container glow scales with pressure
   * - Keyboard controls, demo, presets, pause/reset
   */

  (function () {
    'use strict';

    /* ---------- Config & DOM ---------- */
    const R = 0.082; // L·atm·K^-1·mol^-1
    const n = 1;     // mol

    const canvas = document.getElementById('simCanvas');
    const canvasWrap = document.getElementById('canvasWrap');
    const ctx = canvas.getContext('2d', { alpha: true });

    const modeEl = document.getElementById('mode');
    const volEl = document.getElementById('vol');
    const tempEl = document.getElementById('temp');
    const presEl = document.getElementById('pres');
    const particleCountEl = document.getElementById('particleCount');

    const volVal = document.getElementById('volVal');
    const tempVal = document.getElementById('tempVal');
    const presVal = document.getElementById('presVal');
    const pvBox = document.getElementById('pvBox');
    const vvBox = document.getElementById('vvBox');
    const ttBox = document.getElementById('ttBox');

    const playBtn = document.getElementById('playBtn');
    const resetBtn = document.getElementById('resetBtn');
    const demoBtn = document.getElementById('demoBtn');
    const demoToggle = document.getElementById('demoToggle');
    const isoTempBtn = document.getElementById('isoTemp');
    const isoVolBtn = document.getElementById('isoVol');
    const isoPresBtn = document.getElementById('isoPres');

    // state
    let DPR = Math.max(1, window.devicePixelRatio || 1);
    let paused = false;
    let particles = [];
    let particleCount = parseInt(particleCountEl.value, 10) || 60;
    let demoState = { running: false, timer: null, sequence: null };

    // set default UI values (preserve original defaults)
    volEl.value = 5;
    tempEl.value = 300;
    presEl.value = 1;
    updateReadoutValues();

    /* ---------- Utilities ---------- */
    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
    function lerp(a, b, t) { return a + (b - a) * t; }

    // Map temperature to visible color (smooth)
    function tempToColor(t) {
      // 200K (blue) -> 600K (red)
      const tMin = 200, tMax = 600;
      const norm = clamp((t - tMin) / (tMax - tMin), 0, 1);
      // produce a visually pleasing gradient using HSL
      // blue ~ 210deg, cyan ~ 180deg, orange ~ 35deg, red ~ 10deg
      const hue = norm < 0.45 ? lerp(210, 180, norm / 0.45) : lerp(180, 10, (norm - 0.45) / 0.55);
      const light = lerp(55, 60, norm);
      const sat = lerp(85, 85, norm);
      return `hsl(${Math.round(hue)}deg ${Math.round(sat)}% ${Math.round(light)}%)`;
    }

    /* ---------- Canvas / Layout ---------- */
    function resizeCanvas() {
      DPR = Math.max(1, window.devicePixelRatio || 1);
      // Compute CSS size from container
      const rect = canvasWrap.getBoundingClientRect();
      const cssW = Math.max(220, rect.width || 820);
      const cssH = Math.max(140, rect.height || 420);
      canvas.style.width = cssW + 'px';
      canvas.style.height = cssH + 'px';
      canvas.width = Math.round(cssW * DPR);
      canvas.height = Math.round(cssH * DPR);
      ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
      // Keep particles inside
      const bounds = getBoxRectFromVolume(parseFloat(volEl.value || 5));
      for (let p of particles) {
        p.x = clamp(p.x, bounds.x + p.r, bounds.x + bounds.w - p.r);
        p.y = clamp(p.y, bounds.y + p.r, bounds.y + bounds.h - p.r);
      }
    }

    window.addEventListener('resize', () => { resizeCanvas(); });

    /* ---------- Particles ---------- */
    function makeParticles(count) {
      particles = [];
      // compute bounds as if default V=volEl.value
      const volume = parseFloat(volEl.value) || 5;
      const box = getBoxRectFromVolume(volume);
      // seed particles with small randomized velocities
      for (let i = 0; i < count; i++) {
        const r = lerp(1.8, 3.6, Math.random()); // radius
        particles.push({
          x: box.x + Math.random() * (box.w - 2 * r),
          y: box.y + Math.random() * (box.h - 2 * r),
          vx: (Math.random() - 0.5) * 1.6,
          vy: (Math.random() - 0.5) * 1.6,
          r
        });
      }
    }

    particleCountEl.addEventListener('change', () => {
      particleCount = parseInt(particleCountEl.value, 10) || 60;
      makeParticles(particleCount);
    });

    /* ---------- Geometry helpers ---------- */
    function getBoxRectFromVolume(volume) {
      // We visually map volume (L) to container width; keep height proportional within canvas
      const pad = 12;
      const minW = 140;
      const maxW = Math.max(minW, (canvas.clientWidth || 820) - pad * 2);
      const ratio = clamp((volume - parseFloat(volEl.min || 1)) / (parseFloat(volEl.max || 10) - parseFloat(volEl.min || 1)), 0, 1);
      // map ratio to width range
      const width = lerp(minW, maxW, ratio);
      const x = ((canvas.clientWidth || 820) - width) / 2;
      const y = pad;
      const h = (canvas.clientHeight || 420) - pad * 2;
      return { x: x, y: y, w: width, h: h };
    }

    function roundRect(ctx, x, y, w, h, r) {
      const radius = typeof r === 'number' ? r : 8;
      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.arcTo(x + w, y, x + w, y + h, radius);
      ctx.arcTo(x + w, y + h, x, y + h, radius);
      ctx.arcTo(x, y + h, x, y, radius);
      ctx.arcTo(x, y, x + w, y, radius);
      ctx.closePath();
    }

    /* ---------- Drawing ---------- */
    function clear() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function drawContainer(volume, pressure) {
      const box = getBoxRectFromVolume(volume);
      // pressure normalization based on slider range
      const pmin = parseFloat(presEl.min) || 0.5;
      const pmax = parseFloat(presEl.max) || 5;
      const pnorm = clamp((pressure - pmin) / (pmax - pmin), 0, 1);

      // Outer glow based on pressure
      const glow = 6 + pnorm * 28;
      const strokeAlpha = 0.12 + pnorm * 0.5;
      ctx.save();
      ctx.lineWidth = 4;
      ctx.shadowColor = `rgba(122,107,255,${0.06 + pnorm * 0.28})`;
      ctx.shadowBlur = glow;
      ctx.strokeStyle = `rgba(0,234,255,${strokeAlpha})`;
      roundRect(ctx, box.x, box.y, box.w, box.h, 10);
      ctx.stroke();
      ctx.restore();

      // Inner border
      ctx.save();
      ctx.lineWidth = 1.2;
      ctx.strokeStyle = 'rgba(255,255,255,0.03)';
      roundRect(ctx, box.x + 6, box.y + 6, box.w - 12, box.h - 12, 8);
      ctx.stroke();
      ctx.restore();

      return { x: box.x + 6, y: box.y + 6, width: box.w - 12, h: box.h - 12 };
    }

    function drawParticles(temp, box) {
      const speedFactor = Math.sqrt(temp / 300) * 1.0;
      // compute color once per temp
      const color = tempToColor(temp);
      for (let p of particles) {
        // integrate
        p.x += p.vx * speedFactor;
        p.y += p.vy * speedFactor;

        // collisions with container
        if (p.x - p.r < box.x) {
          p.x = box.x + p.r;
          p.vx *= -1;
          p.vx += (Math.random() - 0.5) * 0.4;
        }
        if (p.x + p.r > box.x + box.width) {
          p.x = box.x + box.width - p.r;
          p.vx *= -1;
          p.vx += (Math.random() - 0.5) * 0.4;
        }
        if (p.y - p.r < box.y) {
          p.y = box.y + p.r;
          p.vy *= -1;
          p.vy += (Math.random() - 0.5) * 0.4;
        }
        if (p.y + p.r > box.y + box.h) {
          p.y = box.y + box.h - p.r;
          p.vy *= -1;
          p.vy += (Math.random() - 0.5) * 0.4;
        }

        // draw with soft glow
        ctx.save();
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.shadowBlur = 6;
        ctx.shadowColor = color;
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      }
    }

    /* ---------- Readouts ---------- */
    function updateReadoutValues(P, V, T) {
      // If values are not passed, read from UI
      let Pval = typeof P === 'number' ? P : parseFloat(presEl.value || presEl.defaultValue);
      let Vval = typeof V === 'number' ? V : parseFloat(volEl.value || volEl.defaultValue);
      let Tval = typeof T === 'number' ? T : parseFloat(tempEl.value || tempEl.defaultValue);
      pvBox.querySelector('.value')?.remove?.();
      // update stat boxes
      document.getElementById('pvBox').querySelector('.value')?.remove?.(); // defensive
      // Use `.querySelector` to ensure we update inner text cleanly
      pvBox.querySelector('.label').nextElementSibling?.remove?.();
      vvBox.querySelector('.label').nextElementSibling?.remove?.();
      ttBox.querySelector('.label').nextElementSibling?.remove?.();

      // create/append value nodes (keeps label intact)
      function setVal(box, txt) {
        const node = document.createElement('div');
        node.className = 'value';
        node.textContent = txt;
        box.appendChild(node);
      }
      setVal(pvBox, `P = ${Number(Pval).toFixed(2)} atm`);
      setVal(vvBox, `V = ${Number(Vval).toFixed(2)} L`);
      setVal(ttBox, `T = ${Number(Tval).toFixed(0)} K`);

      // slider readouts
      volVal.textContent = Number(Vval).toFixed(2) + ' L';
      tempVal.textContent = Number(Tval).toFixed(0) + ' K';
      presVal.textContent = Number(Pval).toFixed(2) + ' atm';
    }

    /* ---------- Gas law enforcement ---------- */
    function enforceGasLaw(mode, V, P, T) {
      // mode: 'boyle' (P-V, T fixed), 'charles' (V-T, P fixed), 'gay' (P-T, V fixed)
      // compute the dependent variable using PV = nRT
      if (mode === 'boyle') {
        // P = n R T / V
        P = (n * R * T) / V;
      } else if (mode === 'charles') {
        // V = n R T / P
        V = (n * R * T) / P;
      } else if (mode === 'gay') {
        // P = n R T / V
        P = (n * R * T) / V;
      }
      // clamp values to slider ranges
      P = clamp(P, parseFloat(presEl.min), parseFloat(presEl.max));
      V = clamp(V, parseFloat(volEl.min), parseFloat(volEl.max));
      return { P, V, T };
    }

    /* ---------- Animation Loop ---------- */
    let lastTs = performance.now();
    function frame(ts) {
      const dt = (ts - lastTs) / 1000 || 0;
      lastTs = ts;

      if (!paused) {
        // Read UI values
        let V = parseFloat(volEl.value);
        let T = parseFloat(tempEl.value);
        let P = parseFloat(presEl.value);
        const mode = modeEl.value;

        // enforce gas law
        const computed = enforceGasLaw(mode, V, P, T);
        P = computed.P; V = computed.V; T = computed.T;

        // write constrained values back to sliders (rounded + no jumpiness)
        presEl.value = Number(P).toFixed(3);
        volEl.value = Number(V).toFixed(3);

        // draw
        clear();
        const drawBox = drawContainer(V, P);
        drawParticles(T, drawBox);

        // update readouts
        updateReadoutValues(P, V, T);
      }

      // request next
      requestAnimationFrame(frame);
    }

    /* ---------- Controls handlers ---------- */
    playBtn.addEventListener('click', () => {
      paused = !paused;
      playBtn.textContent = paused ? 'Play' : 'Pause';
      playBtn.setAttribute('aria-pressed', String(paused));
    });

    resetBtn.addEventListener('click', () => {
      // restore defaults and reseed particles
      volEl.value = 5;
      tempEl.value = 300;
      presEl.value = 1;
      modeEl.value = 'boyle';
      makeParticles(particleCount);
      updateReadoutValues(parseFloat(presEl.value), parseFloat(volEl.value), parseFloat(tempEl.value));
    });

    // presets
    isoTempBtn.addEventListener('click', () => {
      // isothermal: T fixed (300K) — set V & P accordingly (Boyle)
      tempEl.value = 300;
      volEl.value = 5;
      presEl.value = ((n * R * 300) / 5).toFixed(3);
      modeEl.value = 'boyle';
      stopDemo();
    });
    isoVolBtn.addEventListener('click', () => {
      // isochoric: V fixed (3 L) — set P & T accordingly (Gay-Lussac mode)
      volEl.value = 3.0;
      tempEl.value = 300;
      presEl.value = ((n * R * 300) / 3).toFixed(3);
      modeEl.value = 'gay';
      stopDemo();
    });
    isoPresBtn.addEventListener('click', () => {
      // isobaric: P fixed (1 atm) — set V & T accordingly (Charles mode)
      presEl.value = 1.0;
      tempEl.value = 300;
      volEl.value = clamp((n * R * 300) / 1.0, parseFloat(volEl.min), parseFloat(volEl.max)).toFixed(3);
      modeEl.value = 'charles';
      stopDemo();
    });

    // demo sequence
    function startDemo() {
      if (demoState.running) return;
      demoState.running = true;
      demoBtn.textContent = 'Stop Demo';
      // cycle modes and animate temperature
      let step = 0;
      demoState.sequence = setInterval(() => {
        step++;
        const modeCycle = ['boyle', 'charles', 'gay'][step % 3];
        modeEl.value = modeCycle;
        // animate temperature 250 -> 520 over 2s (smooth)
        const from = 260, to = 520, frames = 160;
        let fi = 0;
        const ani = setInterval(() => {
          fi++;
          const p = fi / frames;
          const smooth = 0.5 - 0.5 * Math.cos(Math.PI * p); // ease in-out
          tempEl.value = Math.round(from + (to - from) * smooth);
          if (fi >= frames) clearInterval(ani);
        }, 12);
      }, 6000);
    }
    function stopDemo() {
      if (!demoState.running) return;
      demoState.running = false;
      demoBtn.textContent = 'Run Demo';
      clearInterval(demoState.sequence); demoState.sequence = null;
    }
    demoBtn.addEventListener('click', () => { demoState.running ? stopDemo() : startDemo(); });
    demoToggle.addEventListener('click', () => demoBtn.click());

    // slider live readouts
    volEl.addEventListener('input', () => { volVal.textContent = Number(volEl.value).toFixed(2) + ' L'; });
    tempEl.addEventListener('input', () => { tempVal.textContent = Number(tempEl.value).toFixed(0) + ' K'; });
    presEl.addEventListener('input', () => { presVal.textContent = Number(presEl.value).toFixed(2) + ' atm'; });

    // keyboard controls
    window.addEventListener('keydown', (e) => {
      if (e.code === 'ArrowRight') {
        e.preventDefault();
        volEl.value = clamp(parseFloat(volEl.value) + 0.1, parseFloat(volEl.min), parseFloat(volEl.max)).toFixed(3);
      } else if (e.code === 'ArrowLeft') {
        e.preventDefault();
        volEl.value = clamp(parseFloat(volEl.value) - 0.1, parseFloat(volEl.min), parseFloat(volEl.max)).toFixed(3);
      } else if (e.code === 'Space') {
        e.preventDefault();
        playBtn.click();
      } else if ((e.key || '').toLowerCase() === 'p') {
        window.print();
      }
    });

    // touch-friendly: allow tapping canvas to pause/play
    canvas.addEventListener('click', () => { playBtn.click(); });

    // cleanup
    window.addEventListener('beforeunload', () => {
      stopDemo();
    });

    /* ---------- Initialization ---------- */
    function init() {
      resizeCanvas();
      makeParticles(particleCount);
      updateReadoutValues(parseFloat(presEl.value), parseFloat(volEl.value), parseFloat(tempEl.value));
      // start animation
      requestAnimationFrame(frame);
    }

    // initialize on DOMContentLoaded to ensure sizes measured correctly
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // expose for debugging (optional)
    window.__gasSim = {
      pause: () => { paused = true; },
      play: () => { paused = false; },
      reset: () => { resetBtn.click(); },
      startDemo,
      stopDemo
    };

  })();
  </script>
</body>
</html>
